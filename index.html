<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>X Clone (Vox Firestore Cloud)</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --bg: #ffffff; --text: #0f1419; --border: #eff3f4; --blue: #1d9bf0;
            --hover: rgba(15, 20, 25, 0.1); --dim: #536471; --green: #00ba7c; --red: #f91880;
        }
        [data-theme="dark"] {
            --bg: #000000; --text: #e7e9ea; --border: #2f3336; --blue: #1d9bf0;
            --hover: rgba(231, 233, 234, 0.1); --dim: #71767b; --green: #00ba7c; --red: #f91880;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, sans-serif; }
        body { background: var(--bg); color: var(--text); overflow-x: hidden; touch-action: pan-y; transition: 0.3s; }
        .app-container { display: flex; max-width: 1250px; margin: 0 auto; min-height: 100vh; }
        
        .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; z-index: 2000; }
        .sidebar-drawer { position: fixed; left: -280px; top: 0; width: 280px; height: 100%; background: var(--bg); transition: 0.3s; z-index: 2001; padding: 20px; border-right: 1px solid var(--border); overflow-y: auto; }
        .sidebar-drawer.open { left: 0; }
        .acc-item { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 12px; cursor: pointer; margin-bottom: 5px; }
        .acc-active { border: 1px solid var(--blue); background: var(--hover); }

        nav { width: 275px; padding: 20px; border-right: 1px solid var(--border); position: sticky; top: 0; height: 100vh; display: flex; flex-direction: column; gap: 10px; }
        .nav-link { display: flex; align-items: center; gap: 20px; padding: 12px; border-radius: 30px; cursor: pointer; font-size: 20px; }
        main { flex: 1; max-width: 600px; border-right: 1px solid var(--border); min-height: 100vh; position: relative; }
        header { position: sticky; top: 0; background: var(--bg); opacity: 0.95; backdrop-filter: blur(12px); padding: 16px; border-bottom: 1px solid var(--border); z-index: 50; font-weight: bold; font-size: 20px; display: flex; align-items: center; gap: 15px; }

        .post-card { padding: 16px; border-bottom: 1px solid var(--border); display: flex; gap: 12px; cursor: pointer; position: relative; }
        .avatar { width: 48px; height: 48px; border-radius: 50%; background: #333; background-size: cover; background-position: center; flex-shrink: 0; z-index: 2; position: relative; }
        .thread-line { position: absolute; left: 39px; top: 0; bottom: 0; width: 2px; background: #cfd9de; z-index: 1; display: none; }
        [data-theme="dark"] .thread-line { background: #333639; }
        .is-thread .thread-line { display: block; }
        .thread-start .thread-line { top: 64px; }
        .thread-end .thread-line { height: 40px; }

        .post-actions { display: flex; justify-content: space-between; margin-top: 12px; max-width: 400px; color: var(--dim); }
        .active-rt { color: var(--green); }
        .active-like { color: var(--red); }
        .delete-btn { position: absolute; right: 10px; top: 10px; color: var(--dim); cursor: pointer; display: none; }
        .post-card:hover .delete-btn { display: block; }
        .quote-box { border: 1px solid var(--border); border-radius: 16px; padding: 12px; margin-top: 10px; background: var(--hover); pointer-events: none; }
        .repost-indicator { font-size: 13px; color: var(--dim); margin-bottom: 4px; display: flex; align-items: center; gap: 4px; }

        .dm-item { padding: 16px; display: flex; gap: 12px; border-bottom: 1px solid var(--border); cursor: pointer; align-items: center; }
        .dm-info { flex: 1; min-width: 0; }
        .dm-header { display: flex; justify-content: space-between; align-items: center; }
        .dm-preview { color: var(--dim); font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 2px; }

        .chat-box { height: calc(100vh - 150px); overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; }
        .msg-container { position: relative; max-width: 80%; display: flex; flex-direction: column; }
        .msg-me { align-self: flex-end; align-items: flex-end; }
        .msg-you { align-self: flex-start; align-items: flex-start; }
        .bubble { padding: 10px 16px; border-radius: 20px; font-size: 15px; line-height: 1.4; position: relative; }
        .me-bubble { background: var(--blue) !important; color: white !important; border-bottom-right-radius: 4px !important; }
        .you-bubble { background: var(--border) !important; color: var(--text) !important; border-bottom-left-radius: 4px !important; }
        .msg-time { font-size: 10px; color: var(--dim); margin-top: 4px; }
        .msg-delete { font-size: 10px; color: var(--red); cursor: pointer; opacity: 0; margin-bottom: 2px; }
        .msg-container:hover .msg-delete { opacity: 1; }

        .profile-banner { height: 150px; background: #333; background-size: cover; background-position: center; position: relative; }
        .profile-avatar { width: 80px; height: 80px; border-radius: 50%; border: 4px solid var(--bg); position: absolute; top: -40px; left: 15px; background: #222; background-size: cover; }
        .tab-row { display: flex; border-bottom: 1px solid var(--border); }
        .tab { flex: 1; text-align: center; padding: 15px; cursor: pointer; color: var(--dim); font-weight: bold; }
        .tab.active { color: var(--text); border-bottom: 4px solid var(--blue); }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; z-index: 3000; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: var(--bg); width: 100%; max-width: 600px; border-radius: 20px; padding: 20px; border: 1px solid var(--border); max-height: 95vh; overflow-y: auto; }
        .post-btn-float { position: fixed; bottom: 75px; right: 20px; background: var(--blue); width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; border: none; z-index: 100; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .section { display: none; } .section.active { display: block; }

        @media (max-width: 500px) {
            nav { position: fixed; bottom: 0; width: 100%; height: 55px; flex-direction: row; border-top: 1px solid var(--border); background: var(--bg); justify-content: space-around; z-index: 100; border-right: none; padding: 0; }
            .nav-link span, .desktop-only { display: none; }
            main { max-width: 100%; margin-bottom: 55px; border: none; }
        }
    </style>
</head>
<body data-theme="light">
    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar(false)"></div>
    <div class="sidebar-drawer" id="sidebar-drawer">
        <h2 style="margin-bottom:10px;">Vox Cloud Sync</h2>
        <div id="sync-status" style="margin-bottom:15px; color:var(--blue); font-size:13px; font-weight:bold;">Firestore Ïó∞Í≤∞ Ï§ë...</div>
        <div id="account-list"></div>
        <hr style="border: 0.5px solid var(--border); margin: 20px 0;">
        <div class="sidebar-link" onclick="toggleTheme()" style="padding:15px 0; cursor:pointer;"><i data-lucide="moon"></i> <span id="theme-text">Î∞§ Î™®Îìú ÏºúÍ∏∞</span></div>
        <div class="sidebar-link" onclick="if(confirm('Îç∞Ïù¥ÌÑ∞Î•º Ï¥àÍ∏∞ÌôîÌï†ÍπåÏöî?')){localStorage.clear(); location.reload();}" style="padding:15px 0; cursor:pointer;"><i data-lucide="trash-2"></i> Ï¥àÍ∏∞Ìôî</div>
    </div>

    <div class="app-container">
        <nav>
            <div class="nav-link" onclick="toggleSidebar(true)"><i data-lucide="menu"></i></div>
            <div class="nav-link active" id="nav-home" onclick="switchTab('home')"><i data-lucide="home"></i> <span>Ìôà</span></div>
            <div class="nav-link" id="nav-dm" onclick="switchTab('dm')"><i data-lucide="mail"></i> <span>Ï™ΩÏßÄ</span></div>
            <div class="nav-link" id="nav-profile" onclick="switchTab('profile')"><i data-lucide="user"></i> <span>ÌîÑÎ°úÌïÑ</span></div>
        </nav>

        <main>
            <header>
                <i data-lucide="arrow-left" id="back-btn" style="display:none; cursor:pointer;" onclick="goBack()"></i>
                <span id="page-header-title">Ìôà</span>
            </header>
            <div id="home-section" class="section active"><div id="main-feed-area"></div></div>
            <div id="dm-section" class="section"><div id="dm-content-area"></div></div>
            <div id="profile-section" class="section">
                <div class="profile-banner" id="p-header-bg"></div>
                <div class="profile-info" style="padding: 15px; position: relative; border-bottom: 1px solid var(--border);">
                    <div class="profile-avatar" id="p-avatar-bg"></div>
                    <div id="profile-action-area"></div>
                    <div style="margin-top:50px;">
                        <h2 id="u-name-display"></h2><p id="u-handle-display" style="color:var(--dim)"></p>
                        <p id="u-bio-display" style="margin-top:12px;"></p>
                    </div>
                </div>
                <div class="tab-row">
                    <div class="tab active" onclick="switchProfileTab('tweets', this)">Ìä∏Ïúó</div>
                    <div class="tab" onclick="switchProfileTab('replies', this)">ÎãµÍ∏Ä</div>
                    <div class="tab" onclick="switchProfileTab('likes', this)">ÎßàÏùåÏóê Îì§Ïñ¥Ïöî</div>
                </div>
                <div id="profile-feed-area"></div>
            </div>
            <div id="detail-section" class="section"><div id="detail-area"></div><div id="reply-list-area"></div></div>
        </main>
    </div>

    <button class="post-btn-float" id="float-post-btn" onclick="openModal('post')"><i data-lucide="plus"></i></button>

    <div id="modal" class="modal-overlay" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
                <i data-lucide="x" onclick="closeModal()" style="cursor:pointer"></i>
                <button id="modal-btn" style="background:var(--blue); color:white; border:none; padding:8px 20px; border-radius:30px; font-weight:bold; cursor:pointer;">Ï†ÑÏÜ°</button>
            </div>
            <div id="modal-body"></div>
        </div>
    </div>

    <script>
        // ---------------------------------------------------------
        // 1. Firebase ÏÑ§Ï†ï (Ï†úÍ≥µÌï¥Ï£ºÏã† Í∞íÏúºÎ°ú Ïó∞Îèô!)
        // ---------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyB37N7a8dKvmhf4hGrwEsHP-cmWDmp3eT0",
            authDomain: "twitter-2eaf5.firebaseapp.com",
            projectId: "twitter-2eaf5",
            storageBucket: "twitter-2eaf5.firebasestorage.app",
            messagingSenderId: "407765870582",
            appId: "1:407765870582:web:b1232efb0143b5b856c9d7",
            measurementId: "G-GSZEEH4P05"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const STORAGE_KEY = 'vox_v21_final_sync';
        const getFullTime = () => {
            const d = new Date();
            return `${d.getFullYear()}ÎÖÑ ${d.getMonth()+1}Ïõî ${d.getDate()}Ïùº ${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')}`;
        };

        const defaultState = {
            theme: 'light', currentAccIdx: 0,
            accounts: [
                { id: 0, name: "Ïû¨Ìù¨", handle: "Jaehee_Kim", bio: "Artist / Admin", avatar: "", header: "", joined: "January 2026" },
                { id: 1, name: "Alastor", handle: "RadioDemon", bio: "Smile!", avatar: "", header: "", joined: "December 2022" },
                { id: 2, name: "Vox", handle: "TV_Demon", bio: "Trust me!", avatar: "", header: "", joined: "February 2024" }
            ],
            posts: [{ id: 1, accId: 1, content: "ÏáºÌÉÄÏûÑÏù¥Îã§! (ÏßÄÏßÅ)", likes: [], reposts: [], quotes: 1, time: getFullTime(), isReply: false }],
            dms: [{ pair: [0, 1], messages: [{ s: "Alastor", t: "ÎùºÎîîÏò§ Ï§ÄÎπÑÎêêÎÇò?", time: getFullTime() }] }],
            activeTab: 'home', activeProfileTab: 'tweets', detailId: null, activeChatPair: null, visitingId: null
        };

        let state = defaultState;
        let isSyncing = false;

        // ---------------------------------------------------------
        // 2. Cloud Firestore ÎèôÍ∏∞Ìôî Î°úÏßÅ
        // ---------------------------------------------------------
        const loadFromCloud = async () => {
            try {
                const doc = await db.collection('app_state').doc('global').get();
                if (doc.exists) {
                    state = doc.data();
                    document.getElementById('sync-status').innerText = "‚òÅÔ∏è ÌÅ¥ÎùºÏö∞Îìú ÎèôÍ∏∞Ìôî ÏôÑÎ£å";
                    render(false); // Ïû¨Ï†ÄÏû• Î∞©ÏßÄ
                } else {
                    document.getElementById('sync-status').innerText = "üÜï ÏÉà ÌÅ¥ÎùºÏö∞Îìú Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ± Ï§ë";
                    saveToCloud();
                }
            } catch (e) {
                console.error("Cloud Load Error", e);
                document.getElementById('sync-status').innerText = "‚ö†Ô∏è ÌÅ¥ÎùºÏö∞Îìú Ïó∞Í≤∞ Ïò§Î•ò";
            }
        };

        const saveToCloud = async () => {
            if (isSyncing) return;
            isSyncing = true;
            try {
                await db.collection('app_state').doc('global').set(state);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
                document.getElementById('sync-status').innerText = "‚òÅÔ∏è ÌÅ¥ÎùºÏö∞Îìú Ï†ÄÏû• ÏôÑÎ£å";
            } catch (e) {
                console.error("Cloud Save Error", e);
            }
            isSyncing = false;
        };

        function render(shouldSave = true) {
            if (shouldSave) saveToCloud();
            
            const me = state.accounts[state.currentAccIdx];
            document.body.setAttribute('data-theme', state.theme);
            const title = document.getElementById('page-header-title');
            const backBtn = document.getElementById('back-btn');
            const floatBtn = document.getElementById('float-post-btn');

            backBtn.style.display = (state.detailId || state.activeChatPair || state.visitingId !== null) ? 'block' : 'none';
            floatBtn.style.display = (state.activeTab === 'dm' && state.activeChatPair) ? 'none' : 'flex';

            document.getElementById('account-list').innerHTML = state.accounts.map((acc, i) => `
                <div class="acc-item ${i === state.currentAccIdx ? 'acc-active' : ''}" onclick="switchAccount(${i})">
                    <div class="avatar" style="background-image:url(${acc.avatar})"></div>
                    <div><b>${acc.name}</b><br><span style="color:var(--dim)">@${acc.handle}</span></div>
                </div>`).join('');

            if (state.detailId) {
                const p = state.posts.find(x => x.id === state.detailId);
                if (p) {
                    title.innerText = "Í≤åÏãúÎ¨º";
                    document.getElementById('detail-area').innerHTML = generatePostHTML(p, true);
                    document.getElementById('reply-list-area').innerHTML = state.posts.filter(x => x.replyTo === state.detailId).map(r => generatePostHTML(r, false, false, true, true)).join('');
                }
            } else if (state.activeTab === 'home') {
                title.innerText = 'Ìôà';
                const roots = state.posts.filter(p => !p.isReply);
                let sortedFeed = [];
                roots.forEach(root => {
                    const replies = state.posts.filter(p => p.replyTo === root.id);
                    sortedFeed.push(generatePostHTML(root, false, replies.length > 0));
                    replies.forEach((r, idx) => sortedFeed.push(generatePostHTML(r, false, false, true, idx === replies.length - 1)));
                });
                document.getElementById('main-feed-area').innerHTML = sortedFeed.join('');
            } else if (state.activeTab === 'dm') {
                const dmArea = document.getElementById('dm-content-area');
                if (state.activeChatPair) {
                    const chat = state.dms.find(d => d.pair.includes(state.activeChatPair[0]) && d.pair.includes(state.activeChatPair[1]));
                    const otherId = state.activeChatPair.find(id => id !== state.currentAccIdx);
                    const other = state.accounts[otherId];
                    title.innerText = other.name;
                    dmArea.innerHTML = `<div class="chat-box" id="chat-box-scroll">
                        <div style="text-align:center; padding:20px 0;"><div class="avatar" style="width:64px; height:64px; margin:0 auto 10px; background-image:url(${other.avatar})"></div><b>${other.name}</b><div style="color:var(--dim); font-size:14px;">Joined ${other.joined}</div></div>
                        ${chat ? chat.messages.map((m, idx) => `<div class="msg-container ${m.s===me.name?'msg-me':'msg-you'}"><div class="msg-delete" onclick="deleteMsg(${idx})">ÏÇ≠Ï†ú</div><div class="bubble ${m.s===me.name?'me-bubble':'you-bubble'}">${m.t}</div><div class="msg-time">${m.time}</div></div>`).join('') : ''}
                        </div><div style="padding:15px; border-top:1px solid var(--border); display:flex; gap:10px;"><input id="dm-input" style="flex:1; background:var(--hover); border:none; color:var(--text); padding:10px; border-radius:20px; outline:none;" placeholder="Message" onkeypress="if(event.key==='Enter')sendDM()"><i data-lucide="send" onclick="sendDM()" style="cursor:pointer; color:var(--blue)"></i></div>`;
                    const box = document.getElementById('chat-box-scroll');
                    if (box) box.scrollTop = box.scrollHeight;
                } else {
                    title.innerText = 'Ï™ΩÏßÄ';
                    dmArea.innerHTML = state.accounts.filter(a => a.id !== me.id).map(acc => {
                        const chat = state.dms.find(d => d.pair.includes(me.id) && d.pair.includes(acc.id));
                        return `<div class="dm-item" onclick="enterChat([${me.id}, ${acc.id}])"><div class="avatar" style="background-image:url(${acc.avatar})"></div><div class="dm-info">
                            <div class="dm-header"><b>${acc.name}</b> <span style="color:var(--dim); font-size:12px;">Î∞©Í∏à</span></div>
                            <div class="dm-preview">${chat && chat.messages.length > 0 ? chat.messages[chat.messages.length-1].t : "Ï™ΩÏßÄÎ•º Î≥¥ÎÇ¥Î≥¥ÏÑ∏Ïöî!"}</div>
                        </div></div>`;
                    }).join('');
                }
            } else if (state.activeTab === 'profile') {
                const target = state.visitingId !== null ? state.accounts[state.visitingId] : me;
                title.innerText = target.name;
                document.getElementById('p-header-bg').style.backgroundImage = `url(${target.header})`;
                document.getElementById('p-avatar-bg').style.backgroundImage = `url(${target.avatar})`;
                document.getElementById('u-name-display').innerText = target.name;
                document.getElementById('u-handle-display').innerText = '@' + target.handle;
                document.getElementById('u-bio-display').innerText = target.bio;
                document.getElementById('profile-action-area').innerHTML = `<button onclick="${(state.visitingId === null || state.visitingId === state.currentAccIdx)?'openModal(\'settings\')':'void(0)'}" style="float:right; border:1px solid var(--border); background:none; color:var(--text); padding:8px 16px; border-radius:20px; font-weight:bold; margin-top:10px; cursor:pointer;">${(state.visitingId === null || state.visitingId === state.currentAccIdx)?'ÏàòÏ†ï':'ÌåîÎ°úÏûâ'}</button>`;
                
                let tId = state.visitingId !== null ? state.visitingId : me.id;
                let filtered = state.activeProfileTab === 'tweets' ? state.posts.filter(p => p.accId === tId && !p.isReply) 
                            : state.activeProfileTab === 'replies' ? state.posts.filter(p => p.accId === tId) 
                            : state.posts.filter(p => p.likes.includes(tId));
                document.getElementById('profile-feed-area').innerHTML = filtered.map(p => generatePostHTML(p)).join('') || `<div style="padding:50px; text-align:center; color:var(--dim)">ÎÇ¥Ïö©Ïù¥ ÏóÜÏäµÎãàÎã§.</div>`;
            }
            lucide.createIcons();
        }

        // --- Í∏∞Ï°¥ Í∏∞Îä• Î°úÏßÅ (Î¶¨Ìè¨Ïä§Ìä∏, ÏÇ≠Ï†ú, Ï¢ãÏïÑÏöî Îì± ÏôÑÎ≤Ω Ïú†ÏßÄ) ---
        function generatePostHTML(p, isDetail = false, isStart = false, isReply = false, isEnd = false) {
            const acc = state.accounts[p.accId];
            const isLiked = p.likes.includes(state.currentAccIdx);
            const isRTed = p.reposts?.includes(state.currentAccIdx);
            let threadClass = (isStart ? 'thread-start is-thread' : (isReply ? (isEnd ? 'thread-end is-thread' : 'is-thread') : 'no-thread'));

            return `<div class="post-card ${threadClass}" id="post-${p.id}" onclick="${!isDetail ? `showDetail(${p.id})` : ''}">
                <div class="thread-line"></div>
                <div style="flex:1; z-index:2;">
                    ${p.isRepost ? `<div class="repost-indicator"><i data-lucide="repeat" size="14"></i> ${state.accounts[p.reposterId].name}ÎãòÏù¥ Î¶¨Ìè¨Ïä§Ìä∏ÌñàÏäµÎãàÎã§</div>` : ''}
                    <div style="display:flex; gap:12px;">
                        <div class="avatar" style="background-image:url(${acc.avatar})" onclick="event.stopPropagation(); visitProfile(${p.accId})"></div>
                        <div style="flex:1;">
                            ${p.accId === state.currentAccIdx ? `<i data-lucide="trash-2" size="18" class="delete-btn" onclick="event.stopPropagation(); deletePost(${p.id})"></i>` : ''}
                            <div><b>${acc.name}</b> <span style="color:var(--dim)">@${acc.handle} ¬∑ Î∞©Í∏à</span></div>
                            ${p.isReply && !isDetail ? `<div style="color:var(--dim); font-size:13px;">Replying to @${state.accounts[state.posts.find(x=>x.id===p.replyTo)?.accId || 0].handle}</div>` : ''}
                            <div style="margin:10px 0; font-size:15px; line-height:1.4">${p.content}</div>
                            ${p.quote ? `<div class="quote-box"><b>@${p.quote.handle}</b><br>${p.quote.content}</div>` : ''}
                            ${isDetail ? `<div class="detail-stats" style="margin:10px 0; padding:10px 0; border-top:1px solid var(--border); border-bottom:1px solid var(--border); display:flex; gap:15px;"><span><b>${p.reposts?.length || 0}</b> Î¶¨Ìè¨Ïä§Ìä∏</span><span><b>${p.quotes || 0}</b> Ïù∏Ïö©</span><span><b>${p.likes.length}</b> Ï¢ãÏïÑÏöî</span></div>` : ''}
                            <div class="post-actions" onclick="event.stopPropagation()">
                                <i data-lucide="message-circle" onclick="openModal('reply', ${p.id})"></i>
                                <span class="${isRTed?'active-rt':''}" onclick="openModal('rt-menu', ${p.id})"><i data-lucide="repeat" size="18" style="${isRTed?'stroke:var(--green)':''}"></i> ${p.reposts?.length || 0}</span>
                                <span class="${isLiked?'active-like':''}" onclick="toggleLike(${p.id})"><i data-lucide="heart" size="18" style="${isLiked?'fill:var(--red);stroke:var(--red)':''}"></i> ${p.likes.length}</span>
                                <i data-lucide="share" size="18" onclick="saveAsImage(${p.id})"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function openModal(type, targetId = null) {
            const me = state.accounts[state.currentAccIdx];
            const body = document.getElementById('modal-body'); const btn = document.getElementById('modal-btn');
            let target = targetId ? state.posts.find(x => x.id === targetId) : null;
            if(target && target.originalId) target = state.posts.find(x => x.id === target.originalId);

            document.getElementById('modal').style.display = 'flex'; btn.style.display = "block";
            if (type === 'settings') {
                btn.innerText = "Ï†ÄÏû•";
                body.innerHTML = `Ïù¥Î¶Ñ <input id="set-n" value="${me.name}" style="width:100%; padding:10px; background:var(--hover); border:none; color:var(--text); margin-bottom:10px; border-radius:8px;">
                                 ÏûêÍ∏∞ÏÜåÍ∞ú <textarea id="set-b" style="width:100%; padding:10px; background:var(--hover); border:none; color:var(--text); border-radius:8px;">${me.bio}</textarea>
                                 <br><button onclick="initFile('header')" style="margin:5px; padding:10px; background:var(--blue); color:white; border:none; border-radius:10px; cursor:pointer;">Ìó§Îçî ÏàòÏ†ï</button>
                                 <button onclick="initFile('avatar')" style="margin:5px; padding:10px; background:var(--blue); color:white; border:none; border-radius:10px; cursor:pointer;">ÌîÑÏÇ¨ ÏàòÏ†ï</button>
                                 <input type="file" id="file-input" style="display:none;" onchange="initCrop(this.files[0])">
                                 <div id="crop-wrap" style="display:none;"><div class="crop-area"><img id="crop-target" style="max-width:100%"></div></div>`;
                btn.onclick = () => {
                    me.name = document.getElementById('set-n').value; me.bio = document.getElementById('set-b').value;
                    if(cropper) {
                        const dUrl = cropper.getCroppedCanvas().toDataURL('image/jpeg', 0.8);
                        if(document.getElementById('file-input').dataset.type === 'header') me.header = dUrl; else me.avatar = dUrl;
                    }
                    closeModal(); render();
                };
            } else if (type === 'rt-menu') {
                btn.style.display = "none";
                const isRTed = target.reposts?.includes(state.currentAccIdx);
                body.innerHTML = `<div onclick="toggleRT(${target.id})" style="padding:15px; cursor:pointer; font-weight:bold; color:${isRTed?'var(--red)':'var(--text)'}">${isRTed?'Î¶¨Ìè¨Ïä§Ìä∏ Ï∑®ÏÜå':'Î¶¨Ìè¨Ïä§Ìä∏'}</div><div onclick="closeModal(); openModal('quote', ${target.id})" style="padding:15px; cursor:pointer; font-weight:bold;">Ïù∏Ïö©ÌïòÍ∏∞</div>`;
            } else {
                btn.innerText = "Ï†ÑÏÜ°";
                body.innerHTML = `<textarea id="m-input" placeholder="${type==='reply'?'ÎãµÍ∏Ä':'Î¨¥Ïä® Ïùº?'}" rows="5" style="width:100%; background:none; border:none; color:var(--text); font-size:20px; outline:none; resize:none;"></textarea>${type==='quote'?`<div class="quote-box" style="opacity:0.6">@${state.accounts[target.accId].handle}: ${target.content}</div>`:''}`;
                btn.onclick = () => {
                    const val = document.getElementById('m-input').value; if(!val && type!=='quote') return;
                    if(type==='quote') target.quotes = (target.quotes || 0) + 1;
                    state.posts.unshift({ id: Date.now(), accId: state.currentAccIdx, content: val, likes:[], reposts:[], quotes:0, time: getFullTime(), isReply: type==='reply', replyTo: type==='reply'?target.id:null, quote: type==='quote'?{handle:state.accounts[target.accId].handle, content:target.content, originalId: target.id}:null });
                    closeModal(); render();
                };
            }
            lucide.createIcons();
        }

        let cropper = null;
        window.initFile = (type) => { const input = document.getElementById('file-input'); input.dataset.type = type; input.click(); };
        function initCrop(file) {
            const r = new FileReader(); r.onload = (e) => {
                const img = document.getElementById('crop-target'); img.src = e.target.result;
                document.getElementById('crop-wrap').style.display = 'block'; if(cropper) cropper.destroy();
                cropper = new Cropper(img, { aspectRatio: document.getElementById('file-input').dataset.type === 'header' ? 3/1 : 1/1 });
            }; if(file) r.readAsDataURL(file);
        }

        function deletePost(id) { if(confirm('ÏÇ≠Ï†ú?')) { state.posts = state.posts.filter(p => p.id !== id && p.originalId !== id && (p.quote ? p.quote.originalId !== id : true)); render(); } }
        function toggleRT(id) {
            const p = state.posts.find(x => x.id === id);
            const idx = p.reposts.indexOf(state.currentAccIdx);
            if(idx > -1) { p.reposts.splice(idx, 1); state.posts = state.posts.filter(x => !(x.originalId === id && x.reposterId === state.currentAccIdx)); }
            else { p.reposts.push(state.currentAccIdx); state.posts.unshift({ id: Date.now(), accId: p.accId, content: p.content, likes: p.likes, reposts: p.reposts, quotes: p.quotes, time: p.time, isRepost: true, reposterId: state.currentAccIdx, originalId: p.id }); }
            closeModal(); render();
        }
        function toggleLike(id) { let p = state.posts.find(x => x.id === id); if(p.originalId) p = state.posts.find(x => x.id === p.originalId); const idx = p.likes.indexOf(state.currentAccIdx); if(idx>-1) p.likes.splice(idx,1); else p.likes.push(state.currentAccIdx); render(); }
        function switchAccount(idx) { state.currentAccIdx = idx; state.activeChatPair = null; state.visitingId = null; toggleSidebar(false); render(); }
        function enterChat(pair) { state.activeChatPair = pair.sort((a,b)=>a-b); render(); }
        function sendDM() { const val = document.getElementById('dm-input').value; if (!val) return; let chat = state.dms.find(d => d.pair.includes(state.activeChatPair[0]) && d.pair.includes(state.activeChatPair[1])); if (!chat) { chat = { pair: [...state.activeChatPair].sort((a,b)=>a-b), messages: [] }; state.dms.push(chat); } chat.messages.push({ s: state.accounts[state.currentAccIdx].name, t: val, time: getFullTime() }); render(); }
        function deleteMsg(idx) { const chat = state.dms.find(d => d.pair.includes(state.activeChatPair[0]) && d.pair.includes(state.activeChatPair[1])); if(chat && confirm('ÏÇ≠Ï†ú?')) { chat.messages.splice(idx, 1); render(); } }
        function visitProfile(id) { state.visitingId = id; switchTab('profile'); }
        function switchTab(tab) { state.activeTab = tab; state.detailId = null; state.activeChatPair = null; if(tab!=='profile') state.visitingId = null; document.querySelectorAll('.section').forEach(s => s.classList.remove('active')); document.getElementById(`${tab}-section`).classList.add('active'); render(); }
        function switchProfileTab(t, el) { state.activeProfileTab = t; document.querySelectorAll('.tab').forEach(x => x.classList.remove('active')); el.classList.add('active'); render(); }
        function showDetail(id) { state.detailId = id; document.querySelectorAll('.section').forEach(s => s.classList.remove('active')); document.getElementById('detail-section').classList.add('active'); render(); }
        function goBack() { if(state.detailId) state.detailId = null; else if(state.activeChatPair) state.activeChatPair = null; else if(state.visitingId !== null) state.visitingId = null; render(); }
        function toggleSidebar(open) { document.getElementById('sidebar-overlay').style.display = open?'block':'none'; document.getElementById('sidebar-drawer').classList.toggle('open', open); }
        function toggleTheme() { state.theme = (state.theme === 'light') ? 'dark' : 'light'; render(); }
        function closeModal() { document.getElementById('modal').style.display = 'none'; if(cropper) {cropper.destroy(); cropper=null;} }
        function saveAsImage(id) { html2canvas(document.getElementById(`post-${id}`), {backgroundColor:getComputedStyle(document.body).getPropertyValue('--bg')}).then(c => { openModal('preview', c.toDataURL()); }); }
        
        window.onload = loadFromCloud;
    </script>
</body>
</html>
